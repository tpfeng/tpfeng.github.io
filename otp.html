<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OTP èº«ä»½éªŒè¯å™¨</title>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    :root {
      --primary-color: #007aff; 
      --success-color: #34c759; 
      --error-color: #ff3b30;
      --bg-color: #f2f2f7; 
      --card-bg: #ffffff; 
      --text-main: #1c1c1e; 
      --text-secondary: #3a3a3c;
    }

    body { 
      font-family: "Lantinghei SC", "Microsoft YaHei", "å¾®è½¯é›…é»‘", -apple-system, sans-serif; 
      max-width: 480px; 
      margin: 0 auto; 
      padding: 40px 20px; 
      background: var(--bg-color); 
      color: var(--text-main); 
      -webkit-font-smoothing: antialiased;
      /* ç¦æ­¢ç”¨æˆ·é€‰æ‹©é¡µé¢æ–‡æœ¬ï¼Œå¢åŠ åº”ç”¨æ„Ÿ */
      user-select: none; 
      -webkit-user-select: none;
    }

    .container { 
      background: var(--card-bg); 
      padding: 32px 24px; 
      border-radius: 24px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.08); 
      text-align: center; 
    }

    #mainHeading { display: block; margin: 0 auto 4px auto; font-size: 26px; word-break: break-all; font-weight: 700; line-height: 1.2; color: var(--text-main); }
    #subHeading { display: block; color: var(--text-secondary); font-size: 22px; margin: 0 auto 15px auto; min-height: 1.2em; word-break: break-all; font-weight: 600; line-height: 1.4; }

    .input-wrapper { position: relative; width: 100%; margin: 20px 0; }
    input#secretInput {
      width: 100%; padding: 16px; border: 2px solid var(--primary-color); background: #ffffff;
      border-radius: 14px; box-sizing: border-box; 
      font-family: "Consolas", "Microsoft YaHei", monospace; 
      font-size: 15px; outline: none;
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.1);
      /* è¾“å…¥æ¡†å†…å…è®¸é€‰æ‹©æ–‡æœ¬ï¼Œæ–¹ä¾¿ç”¨æˆ·ä¿®æ”¹å¯†é’¥ */
      user-select: text;
      -webkit-user-select: text;
    }

    .active-secret-bar {
      display: none; 
      background-color: #f0f7ff;
      color: #1c1c1e;
      padding: 12px 16px;
      border-radius: 14px;
      font-size: 14px;
      font-weight: 700;
      margin: -10px 0 20px 0;
      word-break: break-all;
      align-items: center;
      justify-content: center;
      border: 1px solid rgba(0, 122, 255, 0.1);
    }

    .totp-display { 
      font-size: 64px; color: var(--success-color); font-family: "Microsoft YaHei", "Arial", sans-serif; 
      font-weight: 700; margin: 10px 0; font-variant-numeric: tabular-nums; letter-spacing: 0.15em;
    }

    .waiting { color: #d1d1d6; font-size: 32px; letter-spacing: 0; }

    .copy-btn, .next-btn { 
      width: 100%; padding: 15px; border: none; border-radius: 14px; 
      font-weight: 600; cursor: pointer; font-size: 16px; transition: 0.2s; margin-top: 10px;
      font-family: "Microsoft YaHei", sans-serif;
    }
    .copy-btn { background-color: var(--primary-color); color: white; letter-spacing: 0.10em;}
    .next-btn { background-color: #e5e5ea; color: var(--text-main); display: none; }
    .copy-btn:disabled { background-color: #e5e5ea; cursor: not-allowed; }

    .red-notice { display: none; min-height: 55px; font-size: 14px; margin-bottom: 10px; align-items: center; justify-content: center; }
    .error-box { color: var(--error-color); font-weight: bold; background: rgba(255, 59, 48, 0.08); padding: 10px; border-radius: 10px; border: 1px solid rgba(255, 59, 48, 0.2); width: 100%; }
    
    .security-notice {
      margin-top: 25px; font-size: 13px; color: var(--text-secondary);
      line-height: 1.6; padding: 15px; border-radius: 16px;
      background: rgba(255, 59, 48, 0.03); 
      border: 1px dashed var(--error-color);
    }

    .download-link {
      display: inline-flex; align-items: center; justify-content: center;
      margin-top: 8px; color: var(--primary-color); font-weight: 700;
      text-decoration: none; cursor: pointer; transition: 0.2s;
    }
    .download-link:hover { opacity: 0.7; }

    #bookmarkHint {
      display: none;
      margin-top: 12px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .kbd-key {
      display: inline-block; padding: 1px 5px; margin: 0 2px;
      font-family: "Arial", sans-serif; font-size: 10px; font-weight: 800;
      color: #444; background: #fafafa; border: 1px solid #d1d1d6; border-radius: 4px;
      box-shadow: 0 1px 0 #c1c1c6; position: relative; top: -1px;
    }

    #imageOverlay { 
      display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
      background: white; border: 2px solid var(--primary-color); border-radius: 12px; 
      align-items: center; padding: 0 12px; z-index: 100; 
    }
    #imgThumbnail { height: 70%; border-radius: 4px; }
  </style>
</head>
<body>

  <div class="container">
    <h2 id="mainHeading">OTP èº«ä»½éªŒè¯å™¨</h2>
    <h2 id="subHeading"></h2>
    
    <div class="input-wrapper">
      <input type="text" id="secretInput" placeholder="åœ¨è¿™é‡Œç²˜è´´äºŒç»´ç æˆªå›¾ æˆ– è¾“å…¥å¯†é’¥" spellcheck="false" />
      <div id="imageOverlay">
        <img id="imgThumbnail" alt="ç¼©ç•¥å›¾">
        <span style="margin-left:10px; font-size:12px; color:var(--primary-color); font-weight:600;">è¯†åˆ«ä¸­...</span>
      </div>
    </div>

    <div id="activeSecretBar" class="active-secret-bar">
      ğŸ”‘ å½“å‰æœ‰æ•ˆå¯†é’¥: <span id="displaySecretValue" style="margin-left:5px;"></span>
    </div>

    <div id="detectionMsg" class="red-notice"></div>

    <div class="totp-display waiting" id="totp">ç­‰å¾…è¾“å…¥</div>
    
    <div id="countdown-area" style="display: none; margin-bottom: 15px;">
        <span id="timerLabel" style="color:var(--text-secondary); font-size:15px; font-weight: 600; letter-spacing: 0.10em;">æ›´æ–°å‰©ä½™:</span>
        <span id="countdown-num" style="color:var(--primary-color); font-weight:bold; font-size:20px; margin-left:8px;">--s</span>
    </div>
    
    <button class="copy-btn" id="copyBtn" onclick="copyTOTP()" disabled>å¤åˆ¶éªŒè¯ç </button>
    <button class="next-btn" id="nextBtn" onclick="incrementHOTP()">ä¸‹ä¸€æ­¥è®¡æ•° (HOTP)</button>

    <div id="downloadZone" class="security-notice">
      æç¤ºï¼šæœ¬é¡µé¢ä»£ç åœ¨æœ¬åœ°æµè§ˆå™¨è¿è¡Œï¼ŒæœåŠ¡å™¨ä¸ä¿å­˜ä»»ä½•ä¿¡æ¯ã€‚<br>
      <a class="download-link" onclick="downloadPage()">
        <span id="downloadBtnText">[ ä¿å­˜å½“å‰ä¿¡æ¯ä¸ºæœ¬åœ°ç‹¬ç«‹ HTML ]</span>
      </a>
    </div>

    <div id="bookmarkHint">
      ä½¿ç”¨å¿«æ·é”® <span class="kbd-key">Ctrl</span> + <span class="kbd-key">D</span> æ·»åŠ åˆ°æ”¶è—å¤¹
    </div>
  </div>

  <script id="mainScript">
    // --- å®‰å…¨é”å®šï¼šå½»åº•ç¦ç”¨å³é”®èœå• ---
    window.addEventListener('contextmenu', e => e.preventDefault());

    // --- å®‰å…¨é”å®šï¼šç¦æ­¢å¿«æ·é”®ä¿å­˜ (Ctrl+S / Cmd+S) ---
    window.addEventListener('keydown', function (e) {
      if ((e.ctrlKey || e.metaKey) && (e.key === 's' || e.key === 'S')) {
        e.preventDefault();
        alert("è¯·ç‚¹å‡»ä¸‹æ–¹çš„ [ä¿å­˜å½“å‰ä¿¡æ¯] æŒ‰é’®è¿›è¡Œä¿å­˜ã€‚");
      }
    });

    var injectedParams = null; 

    const secretInput = document.getElementById('secretInput');
    const totpDisplay = document.getElementById('totp');
    const copyBtn = document.getElementById('copyBtn');
    const nextBtn = document.getElementById('nextBtn');
    const mainHeading = document.getElementById('mainHeading');
    const subHeading = document.getElementById('subHeading');
    const activeSecretBar = document.getElementById('activeSecretBar');
    const displaySecretValue = document.getElementById('displaySecretValue');
    const detectionMsg = document.getElementById('detectionMsg');
    const bookmarkHint = document.getElementById('bookmarkHint');
    
    let currentConfig = { type: 'totp', secret: '', counter: 0 };
    let isJumping = false;

    function getCurrentParams() {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('secret')) {
        const params = {};
        urlParams.forEach((v, k) => params[k] = v);
        return params;
      }
      return injectedParams;
    }

    function downloadPage() {
      let latestParams = getCurrentParams();
      if (!latestParams || !latestParams.secret) {
        latestParams = {
          type: "totp",
          secret: "ABCDEFGHIJKLMNOP",
          issuer: "",
          label: "æµ‹è¯•è´¦å·"
        };
      }
      let docClone = document.documentElement.cloneNode(true);
      let scriptElement = docClone.querySelector('#mainScript');
      
      const paramsJson = JSON.stringify(latestParams);
      scriptElement.innerHTML = scriptElement.innerHTML.replace(
        /var injectedParams = (null|{.*?});/, 
        `var injectedParams = ${paramsJson};`
      );
      
      const htmlContent = "<!DOCTYPE html>\n" + docClone.outerHTML;
      const blob = new Blob([htmlContent], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const fileName = (latestParams.issuer) ? `OTP_${latestParams.issuer}.html` : 'OTP_Authenticator.html';
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    document.addEventListener('paste', (e) => {
      const items = (e.clipboardData || e.originalEvent.clipboardData).items;
      for (const item of items) {
        if (item.type.indexOf('image') !== -1) {
          const file = item.getAsFile();
          const reader = new FileReader();
          reader.onload = (event) => {
            document.getElementById('imageOverlay').style.display = 'flex';
            document.getElementById('imgThumbnail').src = event.target.result;
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              canvas.width = img.width; canvas.height = img.height;
              ctx.drawImage(img, 0, 0);
              const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
              if (typeof jsQR !== 'undefined') {
                const code = jsQR(imageData.data, canvas.width, canvas.height);
                if (code) { handleResult(code.data); } 
                else { showError("å›¾ç‰‡ä¸­æœªå‘ç°äºŒç»´ç "); document.getElementById('imageOverlay').style.display = 'none'; }
              }
            };
            img.src = event.target.result;
          };
          reader.readAsDataURL(file);
        }
      }
    });

    function handleResult(content) {
      const sMatch = content.match(/secret=([A-Z2-7=]+)/i);
      const secret = sMatch ? sMatch[1].toUpperCase() : (content.match(/[A-Z2-7=]{16,}/i)?.[0].toUpperCase());
      if (secret) {
        isJumping = true;
        let issuer = ""; let label = "";
        const iMatch = content.match(/issuer=([^&]+)/i);
        if (iMatch) issuer = decodeURIComponent(iMatch[1]);
        const labelPart = content.match(/otpauth:\/\/[^/]+\/([^?]+)/i);
        if (labelPart) {
            let fullLabel = decodeURIComponent(labelPart[1]);
            if (fullLabel.includes(':')) {
                let parts = fullLabel.split(':');
                if (!issuer) issuer = parts[0].trim();
                label = parts[1].trim();
            } else { if (!issuer) issuer = fullLabel; else label = fullLabel; }
        }
        const url = new URL(window.location.href);
        url.searchParams.set('secret', secret);
        url.searchParams.set('type', content.includes('hotp') ? 'hotp' : 'totp');
        if (issuer) url.searchParams.set('issuer', issuer);
        if (label) url.searchParams.set('label', label);
        const cMatch = content.match(/counter=(\d+)/i);
        if (cMatch) url.searchParams.set('counter', cMatch[1]);
        detectionMsg.style.display = 'flex';
        detectionMsg.innerHTML = `<b style="color:var(--primary-color)">æ­£åœ¨è¯†åˆ«å¹¶é‡æ–°åŠ è½½...</b>`;
        setTimeout(() => window.location.href = url.href, 500);
      } else { showError("æ— æ•ˆçš„äºŒç»´ç å†…å®¹"); document.getElementById('imageOverlay').style.display = 'none'; }
    }

    async function updateUI() {
      if (isJumping) return;
      const urlParams = new URLSearchParams(window.location.search);
      const urlSecret = urlParams.get('secret') || (injectedParams ? injectedParams.secret : null);
      const inputSecret = secretInput.value.trim();
      
      let activeSecret = ""; let activeType = "totp";

      if (inputSecret) {
        activeSecret = inputSecret.replace(/\s/g, '').toUpperCase();
        mainHeading.textContent = "æ‰‹åŠ¨è¾“å…¥è¯†åˆ«";
        subHeading.textContent = "";
        document.title = "è¯†åˆ«ä¸­... - OTP èº«ä»½éªŒè¯å™¨";
        activeSecretBar.style.display = 'flex';
        displaySecretValue.textContent = activeSecret;
        bookmarkHint.style.display = 'none';
      } else if (urlSecret) {
        activeSecret = urlSecret;
        const finalParams = urlParams.get('secret') ? urlParams : new URLSearchParams(injectedParams);
        activeType = finalParams.get('type') || 'totp';
        currentConfig.counter = parseInt(finalParams.get('counter')) || currentConfig.counter;
        const issuer = finalParams.get('issuer');
        const label = finalParams.get('label');
        if (issuer && label) {
          mainHeading.textContent = issuer; subHeading.textContent = label;
          document.title = `${issuer} (${label}) - éªŒè¯ç `;
        } else if (issuer || label) {
          const name = issuer || label;
          mainHeading.textContent = name; subHeading.textContent = "";
          document.title = `${name} - éªŒè¯ç `;
        } else {
          mainHeading.textContent = "å·²è¯†åˆ«å¯†é’¥"; subHeading.textContent = "";
          document.title = "å·²è¯†åˆ«å¯†é’¥ - éªŒè¯ç ";
        }
        activeSecretBar.style.display = 'flex';
        displaySecretValue.textContent = activeSecret;
        bookmarkHint.style.display = 'block';
      } else {
        mainHeading.textContent = "OTP èº«ä»½éªŒè¯å™¨";
        subHeading.textContent = "";
        document.title = "OTP èº«ä»½éªŒè¯å™¨";
        totpDisplay.textContent = "ç­‰å¾…è¾“å…¥";
        totpDisplay.classList.add('waiting');
        document.getElementById('countdown-area').style.display = 'none';
        copyBtn.disabled = true;
        activeSecretBar.style.display = 'none';
        bookmarkHint.style.display = 'none';
        return;
      }

      try {
        const key = base32ToBytes(activeSecret);
        if(!key) throw Error();
        let cv = (activeType === 'hotp') ? currentConfig.counter : Math.floor(Date.now() / 1000 / 30);
        document.getElementById('countdown-area').style.display = 'block';
        if (activeType === 'totp') {
          document.getElementById('countdown-num').textContent = (30 - (Math.floor(Date.now() / 1000) % 30)) + "s";
          nextBtn.style.display = 'none';
        } else {
          document.getElementById('countdown-num').textContent = currentConfig.counter;
          nextBtn.style.display = 'block';
        }
        const data = new Uint8Array(8);
        for (let i = 7; i >= 0; i--) { data[i] = cv & 0xff; cv >>= 8; }
        const cryptoKey = await crypto.subtle.importKey('raw', key, { name: 'HMAC', hash: 'SHA-1' }, false, ['sign']);
        const hmac = new Uint8Array(await crypto.subtle.sign('HMAC', cryptoKey, data));
        const offset = hmac[hmac.length - 1] & 0xf;
        const code = (((hmac[offset] & 0x7f) << 24) | ((hmac[offset+1] & 0xff) << 16) | ((hmac[offset+2] & 0xff) << 8) | (hmac[offset+3] & 0xff));
        totpDisplay.textContent = (code % 1000000).toString().padStart(6, '0');
        totpDisplay.classList.remove('waiting');
        copyBtn.disabled = false;
      } catch (e) { 
        if(activeSecret.length > 5) { totpDisplay.textContent = "æ ¼å¼æ— æ•ˆ"; copyBtn.disabled = true; }
      }
    }

    function base32ToBytes(s) {
      const alpha = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
      let bits = '';
      for (let i = 0; i < s.length; i++) {
        const idx = alpha.indexOf(s[i]);
        if (idx !== -1) bits += idx.toString(2).padStart(5, '0');
      }
      const bytes = [];
      for (let i = 0; i < bits.length; i += 8) if (i + 8 <= bits.length) bytes.push(parseInt(bits.slice(i, i + 8), 2));
      return new Uint8Array(bytes);
    }

    function incrementHOTP() {
      currentConfig.counter++;
      const url = new URL(window.location.href);
      url.searchParams.set('counter', currentConfig.counter);
      window.history.replaceState({}, '', url);
      updateUI();
    }

    async function copyTOTP() {
      await navigator.clipboard.writeText(totpDisplay.textContent);
      const oldText = copyBtn.textContent;
      copyBtn.textContent = 'âœ… å·²å¤åˆ¶';
      setTimeout(() => copyBtn.textContent = oldText, 2000);
    }

    function showError(msg) {
      detectionMsg.style.display = 'flex';
      detectionMsg.innerHTML = `<div class="error-box">âŒ ${msg}</div>`;
      setTimeout(() => { if(!isJumping) detectionMsg.style.display = 'none'; }, 3000);
    }

    secretInput.addEventListener('input', updateUI);
    setInterval(updateUI, 1000);
    updateUI();
  </script>
</body>
</html>
