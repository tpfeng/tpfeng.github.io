<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="author" content="xuezhong.feng">
  <meta name="copyright" content="Copyright Â© XUEZHONG">
  <meta name="description" content="ä¸€ä¸ªå®‰å…¨çš„æœ¬åœ° OTP èº«ä»½éªŒè¯å·¥å…·">
  <title>OTP èº«ä»½éªŒè¯å™¨</title>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    :root {
      --primary-color: #007aff; 
      --primary-dark: #005ecb; 
      --success-color: #34c759; --error-color: #ff3b30;
      --bg-color: #f2f2f7; --card-bg: #ffffff; --text-main: #1c1c1e; --text-secondary: #3a3a3c;
      --disabled-color: #8e8e93; 
    }

    body { 
      font-family: "Lantinghei SC", "Microsoft YaHei", -apple-system, sans-serif; 
      max-width: 480px; margin: 0 auto; padding: 40px 20px; 
      background: var(--bg-color); color: var(--text-main); -webkit-font-smoothing: antialiased;
      user-select: none;
    }

    .container { 
      background: var(--card-bg); padding: 32px 24px; border-radius: 24px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.08); text-align: center;
      position: relative;
    }

    /* --- ä¹¦ç­¾æç¤ºæ ·å¼ --- */
    .bookmark-tip {
      position: absolute;
      right: 0px;
      top: -30px;
      background: rgba(0, 122, 255, 0.95);
      backdrop-filter: blur(8px);
      color: white;
      padding: 5px 16px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      display: none; 
      align-items: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      z-index: 100;
      white-space: nowrap;
      letter-spacing: 0.05em;
    }

    .bookmark-tip::after {
      content: '';
      position: absolute;
      top: -8px;
      right: 25px;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-bottom: 8px solid rgba(0, 122, 255, 0.95);
    }

    @keyframes bounceTip {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }

    .close-tip {
      margin-left: 10px;
      cursor: pointer;
      font-size: 16px;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    .close-tip:hover { opacity: 1; }

    #mainHeading { font-size: 26px; font-weight: 700; margin-bottom: 60px; word-break: break-all; color: var(--text-main); min-height: 1.2em;}

    .input-group { position: relative; margin: 20px 0; }
    
    .input-container {
      position: relative; display: flex; align-items: center;
      border: 2px solid var(--primary-color); border-radius: 14px; background: #fff; padding: 8px 12px;
    }

    #errorToast {
      position: absolute; top: -45px; left: 50%; transform: translateX(-50%);
      background: var(--error-color); color: white; padding: 8px 16px;
      border-radius: 10px; font-size: 13px; font-weight: 600;
      white-space: nowrap; opacity: 0; transition: opacity 0.3s, top 0.3s;
      pointer-events: none; z-index: 100;
    }
    #errorToast.show { opacity: 1; top: -55px; }

    #secretInput {
      flex: 1; border: none; outline: none; font-family: "Consolas", monospace;
      font-size: 15px; padding: 8px 0; background: transparent; width: 100%;
      user-select: text; 
    }

    #imagePreviewBox {
      display: none; align-items: center; background: #f0f7ff; 
      padding: 4px 8px; border-radius: 8px; border: 1px solid #cce5ff; margin-right: 8px;
    }
    #imgThumbnail { height: 32px; width: 32px; object-fit: cover; border-radius: 4px; }
    .remove-img { color: var(--error-color); margin-left: 6px; cursor: pointer; font-weight: bold; font-size: 18px; line-height: 1; }

    .totp-display { 
      font-size: 64px; color: var(--success-color); font-weight: 700; margin: 20px 0; 
      font-variant-numeric: tabular-nums; letter-spacing: 0.1em;
    }
    .waiting { color: #d1d1d6; font-size: 32px; }

    .copy-btn, .next-btn { 
      width: 100%; padding: 15px; border: none; border-radius: 14px; 
      font-weight: 600; cursor: pointer; font-size: 16px; transition: all 0.2s ease; margin-top: 10px;
      letter-spacing: 0.20em;
    }
    .copy-btn { background: var(--primary-color); color: white; }
    .copy-btn:not(:disabled):hover { background: var(--primary-dark); }
    .copy-btn:not(:disabled):active { transform: scale(0.98); }
    .copy-btn.copied { background: var(--disabled-color) !important; cursor: default; }

    .next-btn { background: #e5e5ea; color: var(--text-main); display: none; }
    .copy-btn:disabled { background: #e5e5ea; cursor: not-allowed; opacity: 0.6; }

    #countdown-area { 
      margin-bottom: 15px; font-size: 14px; color: var(--text-secondary); font-weight: 600;
      letter-spacing: 0.10em; display: flex; align-items: center; justify-content: center;
    }
    #countdown-num { 
      color: var(--primary-color); font-weight: bold; font-size: 18px;
      font-variant-numeric: tabular-nums; display: inline-block;
      min-width: 4ch; text-align: right; margin-right: 8px;
    }

    #hourglass { 
      display: inline-block; min-width: 1.2em; font-size: 16px; 
      will-change: transform, opacity;
      transition: opacity 1s ease; 
    }
    .hg-rotate {
      animation: rotate-ani 0.5s ease-in-out forwards;
    }
    @keyframes rotate-ani {
      from { transform: rotate(0deg); }
      to { transform: rotate(180deg); }
    }

    .privacy-container { margin-top: 30px; border-top: 1px solid #f2f2f7; padding-top: 30px; display: flex; flex-direction: column; align-items: center;}
    
    .ai-btn {
      position: relative; padding: 2px; background: transparent; border: none;
      cursor: pointer; border-radius: 100px; display: inline-flex; align-items: center;
      justify-content: center; overflow: hidden; transition: transform 0.2s; outline: none;
    }
    .ai-btn:active { transform: scale(0.96); }
    .ai-content {
      height: 40px;
      background: #ffffff; color: var(--primary-color); padding: 6px 18px; 
      border-radius: 100px; font-size: 13px; font-weight: 700; z-index: 2; transition: color 0.3s;
      letter-spacing: 0.12em;
      display: flex; align-items: center;
    }
    .ai-btn:hover .ai-content { color: var(--error-color); }

    .ai-orbit {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      border-radius: 100px; padding: 2.5px; 
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude;
    }

    .ai-gradient {
      position: absolute; width: 180%; height: 180%; top: -40%; left: -40%;
      background: conic-gradient(from var(--random-start, 0deg) at 50% 50%, #4285f4 0deg, #ffffff 24deg, #ffffff 64deg, #34a853 100deg, #fbbc05 160deg, #ea4335 200deg, #4285f4 240deg, #4285f4 360deg);
    }
    .ai-running .ai-gradient { animation: ai-rotate 1.5s linear infinite; }
    @keyframes ai-rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .security-notice { 
      display: none; text-align: left; font-size: 13px; color: var(--text-secondary); 
      line-height: 1.6; padding: 20px; margin-top: 30px; background: #f9f9fb; 
      border-radius: 16px; border: 1px solid #eee; width: 100%; box-sizing: border-box; overflow: hidden;
    }
    .security-notice.active { display: block; }

    @keyframes flyInLeft { from { opacity: 0; transform: translateX(-80px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes flyInRight { from { opacity: 0; transform: translateX(80px); } to { opacity: 1; transform: translateX(0); } }
    .info-line { opacity: 0; }
    .security-notice.active .info-line:nth-child(odd) { animation: flyInLeft 0.6s ease-out forwards; }
    .security-notice.active .info-line:nth-child(even) { animation: flyInRight 0.6s ease-out forwards; }
    .security-notice.active .info-line:nth-child(1) { animation-delay: 0.1s; }
    .security-notice.active .info-line:nth-child(2) { animation-delay: 0.25s; }
    .security-notice.active .info-line:nth-child(3) { animation-delay: 0.4s; }

    .kbd-key { display: inline-block; padding: 1px 5px; margin: 0 2px; font-family: "Arial", sans-serif; font-size: 10px; font-weight: 600; color: var(--primary-color); background: #fafafa; border: 1px solid #d1d1d6; border-radius: 4px; }

    #downloadBtn {
      cursor: pointer; font-size: 28px; transition: all 0.3s ease; 
      display: inline-flex; align-items: center; justify-content: center; 
      width: 44px; height: 44px; border-radius: 10px; filter: brightness(1);
    }
    #downloadBtn.downloaded {
      font-size: 13px; font-weight: 700; color: var(--success-color);
      width: auto; padding: 0 10px; cursor: default; filter: none;
    }
  </style>
</head>
<body>

  <div class="container">
    <div class="bookmark-tip" id="bookmarkTip">
      ğŸ“Œ å¼ºçƒˆå»ºè®®æ”¶è—æ­¤é¡µé¢åˆ°ä¹¦ç­¾ã€‚<span class="kbd-key">Ctrl</span> + <span class="kbd-key">D</span>å¯å¿«æ·æ”¶è—ã€‚
      <span class="close-tip" onclick="this.parentElement.style.display='none'">Ã—</span>
    </div>

    <h2 id="mainHeading">OTP èº«ä»½éªŒè¯å™¨</h2>
    
    <div class="input-group">
      <div id="errorToast">ç²˜è´´çš„å›¾ç‰‡ä¸­æœªè¯†åˆ«åˆ°æœ‰æ•ˆå¯†é’¥</div>
      <div class="input-container">
        <div id="imagePreviewBox">
          <img id="imgThumbnail">
          <span class="remove-img" onclick="clearImage()">Ã—</span>
        </div>
        <input type="text" id="secretInput" placeholder="åœ¨è¿™é‡Œç²˜è´´äºŒç»´ç æˆªå›¾ æˆ– è¾“å…¥å¯†é’¥" spellcheck="false" autocomplete="off" />
      </div>
    </div>

    <div id="countdown-area" style="display: none;">
      éªŒè¯ç æ›´æ–°å‰©ä½™: <span id="countdown-num">--s</span><span id="hourglass">âŒ›</span>
    </div>

    <div class="totp-display waiting" id="totp">ç­‰å¾…è¾“å…¥</div>
    
    <button class="copy-btn" id="copyBtn" onclick="copyTOTP()" disabled>å¤åˆ¶éªŒè¯ç </button>
    <button class="next-btn" id="nextBtn" onclick="incrementHOTP()">ä¸‹ä¸€æ­¥è®¡æ•° (HOTP)</button>

    <div class="privacy-container" id="privacyRoot">
      <button type="button" class="ai-btn" id="privacyTrigger">
          <div class="ai-orbit"><div class="ai-gradient"></div></div>
          <div class="ai-content"><span>&emsp;&emsp;æœåŠ¡å™¨ä¸ä¿å­˜ä»»ä½•ä¿¡æ¯å£°æ˜&emsp;&emsp;</span></div>
      </button>
      
      <div id="downloadZone" class="security-notice">
        <div style="font-size: 13px; line-height: 2.2; color: var(--text-secondary);">
          <div class="info-line" style="margin-bottom: 8px;">1ã€<span style="color:var(--error-color); font-weight:600;">æœåŠ¡å™¨ä¸ä¿å­˜ä»»ä½•ä¿¡æ¯</span>ï¼Œæ‰€æœ‰è§£æä¸è®¡ç®—å‡åœ¨æœ¬åœ°æµè§ˆå™¨å®Œæˆã€‚</div>
          <div class="info-line" style="margin-bottom: 8px;">2ã€æ•°æ®ä»…é€šè¿‡ URL é”šç‚¹ (#) ä¸´æ—¶åŠ è½½ï¼Œä¸ä¼šå‘é€è‡³æœåŠ¡å™¨æ—¥å¿—ã€‚</div>
          <div class="info-line">3ã€æ”¯æŒç¦»çº¿ä½¿ç”¨ã€‚ä½¿ç”¨ <span class="kbd-key">Ctrl</span> + <span class="kbd-key">D</span> å³å¯æ”¶è—å½“å‰é¡µé¢ã€‚</div>
        </div>
        <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 15px; padding-top: 12px; border-top: 1px dashed #ddd;">
          <span id="downloadText" style="color: var(--text-main); font-weight: 600; font-size: 13px; transition: opacity 0.3s;">ç‚¹å‡»å³è¾¹å›¾æ ‡ä¿å­˜å½“å‰é¡µé¢åˆ°æœ¬åœ°ç¦»çº¿ä½¿ç”¨</span>
          <span id="downloadBtn" onclick="downloadPage()">ğŸ’¾</span>
        </div>
      </div>
    </div>
  </div>

  <script id="mainScript">
    var injectedParams = null;
    const secretInput = document.getElementById('secretInput');
    const totpDisplay = document.getElementById('totp');
    const copyBtn = document.getElementById('copyBtn');
    const nextBtn = document.getElementById('nextBtn');
    const mainHeading = document.getElementById('mainHeading');
    const previewBox = document.getElementById('imagePreviewBox');
    const imgThumbnail = document.getElementById('imgThumbnail');
    const errorToast = document.getElementById('errorToast');
    const hourglass = document.getElementById('hourglass');
    const bookmarkTip = document.getElementById('bookmarkTip');

    let currentConfig = { secret: "", type: "totp", issuer: "", label: "", counter: 0 };
    // let isHgAnimating = false; // ä¸å†éœ€è¦é”å®šå˜é‡

    function stepHourglass() {
      // æ¯æ¬¡è°ƒç”¨é‡ç½®åŠ¨ç”»ï¼Œä½¿å…¶ä¸ç§’æ•°åŒæ­¥
      hourglass.classList.remove('hg-rotate');
      void hourglass.offsetWidth; // è§¦å‘ Reflow ä»¥é‡å¯ CSS åŠ¨ç”»
      hourglass.classList.add('hg-rotate');
      
      // åœ¨åŠ¨ç”»ä¸­é—´åˆ‡æ¢å›¾æ ‡
      setTimeout(() => {
        hourglass.textContent = (hourglass.textContent === "âŒ›") ? "â³" : "âŒ›";
        hourglass.style.opacity = '1';
      }, 250); 
    }

    const trigger = document.getElementById('privacyTrigger');
    const notice = document.getElementById('downloadZone');
    const aiGradient = document.querySelector('.ai-gradient');

    function setRandomAngle() { if(aiGradient) aiGradient.style.setProperty('--random-start', `${Math.floor(Math.random() * 360)}deg`); }
    function runAiAnimation() {
      if(!trigger) return;
      trigger.classList.remove('ai-running');
      void trigger.offsetWidth;
      trigger.classList.add('ai-running');
      setTimeout(() => { if(trigger) trigger.classList.remove('ai-running'); setRandomAngle(); }, 1500);
    }

    if(trigger && notice) {
      setRandomAngle();
      window.addEventListener('load', () => setTimeout(runAiAnimation, 800));
      trigger.addEventListener('mouseenter', () => {
        if (!notice.classList.contains('active')) {
          notice.classList.add('active');
        }
        runAiAnimation();
      });
      trigger.addEventListener('click', () => {
        notice.classList.toggle('active');
        runAiAnimation();
      });
    }

    function downloadPage() {
      const dlBtn = document.getElementById('downloadBtn');
      const dlText = document.getElementById('downloadText');
      if (dlBtn.classList.contains('downloaded')) return;
      let latestParams = (currentConfig && currentConfig.secret) ? currentConfig : { type: "totp", secret: "ABCDEFGHIJKLMNOP", issuer: "æ¼”ç¤ºç¤ºä¾‹", label: "ExampleUser" };
      let docClone = document.documentElement.cloneNode(true);
      const pRoot = docClone.querySelector('#privacyRoot');
      if (pRoot) pRoot.remove();
      const bTip = docClone.querySelector('#bookmarkTip');
      if (bTip) bTip.remove();
      let scriptElement = docClone.querySelector('#mainScript');
      const paramsJson = JSON.stringify(latestParams);
      scriptElement.innerHTML = scriptElement.innerHTML.replace(/var injectedParams = (null|{.*?});/, `var injectedParams = ${paramsJson};`);
      const htmlContent = "<!DOCTYPE html>\n" + docClone.outerHTML;
      const blob = new Blob([htmlContent], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = (latestParams.issuer && latestParams.issuer !== "æ¼”ç¤ºç¤ºä¾‹") ? `OTP_${latestParams.issuer}.html` : 'OTP_Authenticator.html';
      a.click();
      dlBtn.textContent = 'å·²ä¸‹è½½';
      dlBtn.classList.add('downloaded');
      if(dlText) dlText.style.opacity = '0.4';
    }

    let lastEpoch = 0; // è®°å½•ä¸Šä¸€ç§’ï¼Œé˜²æ­¢é‡å¤è®¡ç®—

    async function calculate() {
      if (!currentConfig.secret || currentConfig.secret.length < 4) { resetUI(); return; }
      
      let epoch = Math.floor(Date.now() / 1000);
      
      // ä¼˜åŒ–ï¼šåªæœ‰ç§’æ•°å˜åŒ–æ—¶æ‰æ›´æ–°ç•Œé¢ï¼Œé¿å…é¢‘é—ªå’Œè·³ç§’
      if (epoch === lastEpoch) return;
      lastEpoch = epoch;

      try {
        const key = base32ToBytes(currentConfig.secret);
        
        stepHourglass(); // ç§’æ•°æ›´æ–°ï¼Œè§¦å‘æ²™æ¼
        
        const countArea = document.getElementById('countdown-area');
        const countNum = document.getElementById('countdown-num');
        if(countArea) countArea.style.display = 'flex';
        if (currentConfig.type === 'totp') {
          if(countNum) countNum.textContent = (30 - (epoch % 30)) + "s";
          nextBtn.style.display = 'none';
        } else {
          if(countNum) countNum.textContent = currentConfig.counter;
          nextBtn.style.display = 'block';
        }
        const data = new Uint8Array(8);
        let cv = (currentConfig.type === 'hotp') ? currentConfig.counter : Math.floor(epoch / 30);
        for (let i = 7; i >= 0; i--) { data[i] = cv & 0xff; cv >>= 8; }
        const cryptoKey = await crypto.subtle.importKey('raw', key, { name: 'HMAC', hash: 'SHA-1' }, false, ['sign']);
        const hmac = new Uint8Array(await crypto.subtle.sign('HMAC', cryptoKey, data));
        const offset = hmac[hmac.length - 1] & 0xf;
        const code = ((hmac[offset] & 0x7f) << 24 | (hmac[offset+1] & 0xff) << 16 | (hmac[offset+2] & 0xff) << 8 | (hmac[offset+3] & 0xff)) % 1000000;
        totpDisplay.textContent = code.toString().padStart(6, '0');
        totpDisplay.classList.remove('waiting');
        if (!copyBtn.classList.contains('copied')) copyBtn.disabled = false;
      } catch (e) { resetUI(); }
    }

    function base32ToBytes(s) {
      const alpha = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
      let bits = "";
      for (let i = 0; i < s.length; i++) {
        const val = alpha.indexOf(s[i].toUpperCase());
        if (val >= 0) bits += val.toString(2).padStart(5, '0');
      }
      const bytes = [];
      for (let i = 0; i < bits.length; i += 8) if(i+8<=bits.length) bytes.push(parseInt(bits.slice(i, i+8), 2));
      return new Uint8Array(bytes);
    }

    function parseOtpAuth(content) {
      if (!content.toLowerCase().startsWith('otpauth://')) return false;
      try {
        const secretMatch = content.match(/secret=([a-z2-7=]+)/i);
        if (!secretMatch) return false;
        currentConfig.secret = secretMatch[1].toUpperCase();
        const issuerMatch = content.match(/issuer=([^&]+)/i);
        currentConfig.issuer = issuerMatch ? decodeURIComponent(issuerMatch[1]).replace(/\+/g, ' ') : "";
        currentConfig.type = content.toLowerCase().includes('/hotp/') ? 'hotp' : 'totp';
        const labelMatch = content.match(/otpauth:\/\/[^\/]+\/([^?]+)/i);
        if (labelMatch) {
            let labelText = decodeURIComponent(labelMatch[1]).replace(/\+/g, ' ');
            currentConfig.label = labelText.includes(':') ? labelText.split(':')[1].trim() : labelText.trim();
        }
        updateSecretInputDisplay();
        return true;
      } catch (e) { return false; }
    }

    function updateUrlHash() {
      if (!currentConfig.secret) { window.history.replaceState(null, "", window.location.pathname); return; }
      try {
        const jsonStr = JSON.stringify(currentConfig);
        const b64 = btoa(unescape(encodeURIComponent(jsonStr)));
        window.history.replaceState(null, "", "#" + b64);
      } catch(e) {}
    }

    function updateHeadingAndTitle() {
      let { issuer, label, secret } = currentConfig;
      let displayHeading = "OTP èº«ä»½éªŒè¯å™¨";
      if (issuer && label) displayHeading = (issuer.toLowerCase() === label.toLowerCase()) ? issuer : `${issuer} (${label})`;
      else if (issuer || label) displayHeading = issuer || label;
      mainHeading.textContent = displayHeading;
      document.title = secret ? displayHeading : "OTP èº«ä»½éªŒè¯å™¨";
    }

    function updateSecretInputDisplay() {
      if (currentConfig.secret && currentConfig.secret.length >= 8) {
        const s = currentConfig.secret;
        secretInput.value = s.substring(0, 4) + "********" + s.substring(s.length - 4);
      } else {
        secretInput.value = currentConfig.secret;
      }
    }

    secretInput.addEventListener('focus', function() { this.value = currentConfig.secret; });
    secretInput.addEventListener('blur', function() { updateSecretInputDisplay(); });

    secretInput.addEventListener('input', (e) => {
      const val = e.target.value.trim();
      if (val.toLowerCase().startsWith('otpauth://')) { parseOtpAuth(val); }
      else if (!val.includes('*')) {
          currentConfig.secret = val.toUpperCase().replace(/\s/g, '');
          currentConfig.type = "totp"; currentConfig.issuer = ""; currentConfig.label = "";
      }
      saveAndRender();
    });

    document.addEventListener('paste', (e) => {
      const items = (e.clipboardData || e.originalEvent.clipboardData).items;
      for (let item of items) {
        if (item.type.indexOf('image') !== -1) {
          const file = item.getAsFile();
          const reader = new FileReader();
          reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
              const cvs = document.createElement('canvas');
              cvs.width = img.width; cvs.height = img.height;
              const ctx = cvs.getContext('2d');
              ctx.drawImage(img, 0, 0);
              const qr = jsQR(ctx.getImageData(0, 0, cvs.width, cvs.height).data, cvs.width, cvs.height);
              if (qr && parseOtpAuth(qr.data)) {
                  imgThumbnail.src = event.target.result; previewBox.style.display = 'flex'; saveAndRender();
                  bookmarkTip.style.display = 'flex';
                  bookmarkTip.style.animation = 'bounceTip 2s infinite';
                  setTimeout(() => {
                    bookmarkTip.style.display = 'none';
                  }, 20000);
              } else {
                  showError();
              }
            };
            img.src = event.target.result;
          };
          reader.readAsDataURL(file);
        }
      }
    });

    function showError() { errorToast.classList.add('show'); setTimeout(() => errorToast.classList.remove('show'), 3000); }
    function resetUI() { totpDisplay.textContent = "ç­‰å¾…è¾“å…¥"; totpDisplay.classList.add('waiting'); copyBtn.disabled = true; const area = document.getElementById('countdown-area'); if(area) area.style.display = 'none'; updateHeadingAndTitle(); }
    function clearImage() { previewBox.style.display = 'none'; imgThumbnail.src = ""; }
    function saveAndRender() { localStorage.setItem('otp_secret', currentConfig.secret); updateUrlHash(); updateHeadingAndTitle(); calculate(); }

    async function copyTOTP() {
      if (copyBtn.classList.contains('copied')) return;
      await navigator.clipboard.writeText(totpDisplay.textContent);
      copyBtn.textContent = 'âœ… å·²å¤åˆ¶'; copyBtn.classList.add('copied'); copyBtn.disabled = true;
      setTimeout(() => { copyBtn.textContent = 'å¤åˆ¶éªŒè¯ç '; copyBtn.classList.remove('copied'); if (!totpDisplay.classList.contains('waiting')) copyBtn.disabled = false; }, 2000);
    }

    function incrementHOTP() { currentConfig.counter++; saveAndRender(); }

    function enableSecurityBlock() {
      document.addEventListener('contextmenu', e => e.preventDefault());
      document.addEventListener('keydown', e => {
        if (e.key === 'F12') e.preventDefault();
        if ((e.ctrlKey || e.metaKey) && ['s', 'u', 'p'].includes(e.key.toLowerCase())) e.preventDefault();
      });
    }

    function init() {
      enableSecurityBlock();
      let secret = "";
      const hash = window.location.hash.substring(1);
      if (hash) {
        try {
          const decoded = JSON.parse(decodeURIComponent(escape(atob(hash))));
          currentConfig = {...currentConfig, ...decoded};
          secret = currentConfig.secret;
        } catch(e) { let params = new URLSearchParams(hash); secret = params.get('secret'); }
      }
      secret = secret || (injectedParams?.secret) || localStorage.getItem('otp_secret');
      if (secret) {
        currentConfig.secret = secret.toUpperCase();
        currentConfig.type = (injectedParams?.type) || currentConfig.type;
        currentConfig.issuer = (injectedParams?.issuer) || currentConfig.issuer;
        currentConfig.label = (injectedParams?.label) || currentConfig.label;
        currentConfig.counter = (injectedParams?.counter) || currentConfig.counter;
        updateSecretInputDisplay();
        saveAndRender();
      }
    }

    // æé«˜å®šæ—¶å™¨é¢‘ç‡åˆ° 200msï¼Œé…åˆ calculate ä¸­çš„ lastEpoch åˆ¤æ–­ï¼Œå®ç°ç²¾ç¡®çš„æ•´ç§’è·³åŠ¨
    setInterval(calculate, 200);
    init();
  </script>
</body>
</html>
