<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OTP èº«ä»½éªŒè¯å™¨</title>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    :root {
      --primary-color: #007aff; 
      --success-color: #34c759; 
      --error-color: #ff3b30;
      --bg-color: #f2f2f7; 
      --card-bg: #ffffff; 
      --text-main: #1c1c1e; 
      --text-secondary: #3a3a3c;
    }

    body { 
      font-family: "Lantinghei SC", "Microsoft YaHei", -apple-system, sans-serif; 
      max-width: 480px; margin: 0 auto; padding: 40px 20px; background: var(--bg-color); 
      color: var(--text-main); -webkit-font-smoothing: antialiased;
      user-select: none; -webkit-user-select: none;
    }

    .container { background: var(--card-bg); padding: 32px 24px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); text-align: center; }
    #mainHeading { display: block; margin: 0 auto 4px auto; font-size: 26px; word-break: break-all; font-weight: 700; line-height: 1.2; }
    #subHeading { display: block; color: var(--text-secondary); font-size: 22px; margin: 0 auto 15px auto; min-height: 1.2em; word-break: break-all; font-weight: 600; }

    .input-wrapper { position: relative; width: 100%; margin: 20px 0; }
    input#secretInput {
      width: 100%; padding: 16px; border: 2px solid var(--primary-color); background: #ffffff;
      border-radius: 14px; box-sizing: border-box; font-size: 15px; outline: none;
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.1); user-select: text; -webkit-user-select: text;
    }

    .active-secret-bar {
      display: none; background-color: #f0f7ff; color: #1c1c1e; padding: 12px 16px;
      border-radius: 14px; font-size: 14px; font-weight: 700; margin: -10px 0 20px 0;
      border: 1px solid rgba(0, 122, 255, 0.1); justify-content: center; align-items: center;
    }

    .totp-display { 
      font-size: 64px; color: var(--success-color); font-weight: 700; margin: 10px 0; 
      font-variant-numeric: tabular-nums; letter-spacing: 0.15em;
    }
    .waiting { color: #d1d1d6; font-size: 32px; letter-spacing: 0; }

    .copy-btn { 
      width: 100%; padding: 15px; border: none; border-radius: 14px; 
      font-weight: 600; cursor: pointer; font-size: 16px; margin-top: 10px;
      background-color: var(--primary-color); color: white;
    }
    .copy-btn:disabled { background-color: #e5e5ea; cursor: not-allowed; }

    .red-notice { display: none; min-height: 55px; font-size: 14px; margin-bottom: 10px; align-items: center; justify-content: center; }
    .security-notice {
      margin-top: 25px; font-size: 13px; color: var(--text-secondary); line-height: 1.6; 
      padding: 15px; border-radius: 16px; background: rgba(255, 59, 48, 0.03); border: 1px dashed var(--error-color);
    }
    .download-link { display: inline-flex; align-items: center; justify-content: center; margin-top: 8px; color: var(--primary-color); font-weight: 700; text-decoration: none; cursor: pointer; }
    #bookmarkHint { display: none; margin-top: 12px; font-size: 12px; color: var(--text-secondary); font-weight: 600; }
    .kbd-key { display: inline-block; padding: 1px 5px; margin: 0 2px; font-size: 10px; background: #fafafa; border: 1px solid #d1d1d6; border-radius: 4px; color: var(--primary-color); }
    
    #imageOverlay { display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: white; border: 2px solid var(--primary-color); border-radius: 12px; align-items: center; padding: 0 12px; z-index: 100; }
    #imgThumbnail { height: 70%; border-radius: 4px; }
  </style>
</head>
<body>

  <div class="container">
    <h2 id="mainHeading">OTP èº«ä»½éªŒè¯å™¨</h2>
    <h2 id="subHeading"></h2>
    
    <div class="input-wrapper">
      <input type="text" id="secretInput" placeholder="ç²˜è´´äºŒç»´ç æˆªå›¾ æˆ– è¾“å…¥å¯†é’¥" spellcheck="false" />
      <div id="imageOverlay"><img id="imgThumbnail" alt="ç¼©ç•¥å›¾"><span style="margin-left:10px; font-size:12px; color:var(--primary-color); font-weight:600;">è¯†åˆ«ä¸­...</span></div>
    </div>

    <div id="activeSecretBar" class="active-secret-bar">
      ğŸ”‘ å¯†é’¥: <span id="displaySecretValue" style="margin-left:5px; font-family: 'Consolas', monospace; letter-spacing: 0.05em;"></span>
    </div>

    <div id="detectionMsg" class="red-notice"></div>
    <div class="totp-display waiting" id="totp">ç­‰å¾…è¾“å…¥</div>
    
    <div id="countdown-area" style="display: none; margin-bottom: 15px;">
        <span style="color:var(--text-secondary); font-size:15px; font-weight: 600;">æ›´æ–°å‰©ä½™:</span>
        <span id="countdown-num" style="color:var(--primary-color); font-weight:bold; font-size:20px; margin-left:8px;">--s</span>
    </div>
    
    <button class="copy-btn" id="copyBtn" onclick="copyTOTP()" disabled>å¤åˆ¶éªŒè¯ç </button>

    <div id="downloadZone" class="security-notice">
      æç¤ºï¼šæœ¬é¡µé¢ä»£ç åœ¨æœ¬åœ°æµè§ˆå™¨è¿è¡Œï¼Œä¸ä¸Šä¼ ä»»ä½•ä¿¡æ¯ã€‚<br>
      <a class="download-link" onclick="downloadPage()">
        <span>[ ä¿å­˜å½“å‰ä¿¡æ¯ä¸ºæœ¬åœ°ç‹¬ç«‹ HTML ]</span>
      </a>
    </div>

    <div id="bookmarkHint">ä½¿ç”¨å¿«æ·é”® <span class="kbd-key">Ctrl</span> + <span class="kbd-key">D</span> å¯æ·»åŠ åˆ°æ”¶è—å¤¹</div>
  </div>

  <script id="mainScript">
    // ç¦æ­¢ä¿å­˜å¿«æ·é”®å’Œå³é”®
    window.addEventListener('contextmenu', e => e.preventDefault());
    window.addEventListener('keydown', e => {
      if ((e.ctrlKey || e.metaKey) && (e.key === 's' || e.key === 'S')) {
        e.preventDefault();
        alert("è¯·ä½¿ç”¨é¡µé¢å†…çš„ä¿å­˜æŒ‰é’®ã€‚");
      }
    });

    var injectedParams = null; 
    const secretInput = document.getElementById('secretInput');
    const totpDisplay = document.getElementById('totp');
    const copyBtn = document.getElementById('copyBtn');
    const mainHeading = document.getElementById('mainHeading');
    const subHeading = document.getElementById('subHeading');
    const activeSecretBar = document.getElementById('activeSecretBar');
    const displaySecretValue = document.getElementById('displaySecretValue');
    const detectionMsg = document.getElementById('detectionMsg');
    const bookmarkHint = document.getElementById('bookmarkHint');
    
    let isJumping = false;

    // --- å¯†é’¥è„±æ•é€»è¾‘ï¼šå‰4å4ï¼Œä¸­é—´æ›¿æ¢ä¸ºç­‰é•¿* ---
    function maskSecret(s) {
      if (!s) return "";
      if (s.length <= 8) return s; 
      const start = s.substring(0, 4);
      const end = s.substring(s.length - 4);
      const masks = "*".repeat(s.length - 8);
      return start + masks + end;
    }

    function getCurrentParams() {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('secret')) return Object.fromEntries(urlParams);
      return injectedParams;
    }

    function downloadPage() {
      let latestParams = getCurrentParams() || { secret: secretInput.value.trim().replace(/\s/g, '').toUpperCase(), issuer: "æ‰‹åŠ¨è¾“å…¥", label: "" };
      let docClone = document.documentElement.cloneNode(true);
      let scriptElement = docClone.querySelector('#mainScript');
      scriptElement.innerHTML = scriptElement.innerHTML.replace(/var injectedParams = (null|{.*?});/, `var injectedParams = ${JSON.stringify(latestParams)};`);
      const blob = new Blob(["<!DOCTYPE html>\n" + docClone.outerHTML], { type: 'text/html' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = latestParams.issuer ? `OTP_${latestParams.issuer}.html` : 'OTP_Authenticator.html';
      a.click();
    }

    // ç²˜è´´å›¾ç‰‡è¯†åˆ«
    document.addEventListener('paste', e => {
      const item = [...(e.clipboardData || e.originalEvent.clipboardData).items].find(i => i.type.includes('image'));
      if (item) {
        const reader = new FileReader();
        reader.onload = event => {
          document.getElementById('imageOverlay').style.display = 'flex';
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = img.width; canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            const code = jsQR(ctx.getImageData(0,0,canvas.width,canvas.height).data, canvas.width, canvas.height);
            if (code) handleResult(code.data);
            else { alert("æœªè¯†åˆ«åˆ°äºŒç»´ç "); document.getElementById('imageOverlay').style.display = 'none'; }
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(item.getAsFile());
      }
    });

    function handleResult(content) {
      const sMatch = content.match(/secret=([A-Z2-7=]+)/i);
      const secret = sMatch ? sMatch[1].toUpperCase() : (content.match(/[A-Z2-7=]{16,}/i)?.[0].toUpperCase());
      if (secret) {
        isJumping = true;
        const url = new URL(window.location.href);
        url.searchParams.set('secret', secret);
        const iMatch = content.match(/issuer=([^&]+)/i);
        if (iMatch) url.searchParams.set('issuer', decodeURIComponent(iMatch[1]));
        const labelPart = content.match(/otpauth:\/\/[^/]+\/([^?]+)/i);
        if (labelPart) url.searchParams.set('label', decodeURIComponent(labelPart[1].split(':').pop()));
        window.location.href = url.href;
      }
    }

    async function updateUI() {
      if (isJumping) return;
      const params = getCurrentParams();
      const inputSecret = secretInput.value.trim().replace(/\s/g, '').toUpperCase();
      let activeSecret = inputSecret || (params ? params.secret : "");

      if (!activeSecret) {
        mainHeading.textContent = "OTP èº«ä»½éªŒè¯å™¨"; subHeading.textContent = "";
        totpDisplay.textContent = "ç­‰å¾…è¾“å…¥"; totpDisplay.classList.add('waiting');
        activeSecretBar.style.display = 'none'; bookmarkHint.style.display = 'none';
        document.getElementById('countdown-area').style.display = 'none';
        return;
      }

      if (inputSecret) {
        mainHeading.textContent = "æ­£åœ¨è¯†åˆ«..."; subHeading.textContent = "";
      } else if (params) {
        mainHeading.textContent = params.issuer || "å·²è¯†åˆ«å¯†é’¥";
        subHeading.textContent = params.label || "";
        bookmarkHint.style.display = 'block';
      }

      activeSecretBar.style.display = 'flex';
      displaySecretValue.textContent = maskSecret(activeSecret);

      try {
        const key = base32ToBytes(activeSecret);
        const epoch = Math.floor(Date.now() / 1000);
        
        document.getElementById('countdown-area').style.display = 'block';
        document.getElementById('countdown-num').textContent = (30 - (epoch % 30)) + "s";

        const cryptoKey = await crypto.subtle.importKey('raw', key, { name: 'HMAC', hash: 'SHA-1' }, false, ['sign']);
        const data = new Uint8Array(8);
        let cv = BigInt(Math.floor(epoch / 30));
        for (let i = 7; i >= 0; i--) { data[i] = Number(cv & 0xffn); cv >>= 8n; }
        
        const hmac = new Uint8Array(await crypto.subtle.sign('HMAC', cryptoKey, data));
        const offset = hmac[19] & 0xf;
        const code = ((hmac[offset] & 0x7f) << 24 | (hmac[offset+1] & 0xff) << 16 | (hmac[offset+2] & 0xff) << 8 | (hmac[offset+3] & 0xff)) % 1000000;
        
        const finalCode = code.toString().padStart(6, '0');
        totpDisplay.textContent = finalCode;
        totpDisplay.classList.remove('waiting');
        copyBtn.disabled = false;
        document.title = (params?.issuer || "OTP") + " - " + finalCode;
      } catch (e) { 
        if(activeSecret.length > 5) totpDisplay.textContent = "æ— æ•ˆå¯†é’¥"; 
      }
    }

    function base32ToBytes(s) {
      const alpha = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
      let bits = "";
      for (let i = 0; i < s.length; i++) {
        const val = alpha.indexOf(s[i].toUpperCase());
        if (val >= 0) bits += val.toString(2).padStart(5, '0');
      }
      const bytes = [];
      for (let i = 0; i + 8 <= bits.length; i += 8) bytes.push(parseInt(bits.substr(i, 8), 2));
      return new Uint8Array(bytes);
    }

    async function copyTOTP() {
      await navigator.clipboard.writeText(totpDisplay.textContent);
      const old = copyBtn.textContent; copyBtn.textContent = 'âœ… å·²å¤åˆ¶';
      setTimeout(() => copyBtn.textContent = old, 2000);
    }

    setInterval(updateUI, 1000);
    updateUI();
  </script>
</body>
</html>
