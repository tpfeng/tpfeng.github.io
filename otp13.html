<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OTP èº«ä»½éªŒè¯å™¨</title>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    :root {
      --primary-color: #007aff; --success-color: #34c759; --error-color: #ff3b30;
      --bg-color: #f2f2f7; --card-bg: #ffffff; --text-main: #1c1c1e; --text-secondary: #3a3a3c;
    }
    body { 
      font-family: "Lantinghei SC", "Microsoft YaHei", -apple-system, sans-serif; 
      max-width: 480px; margin: 0 auto; padding: 40px 20px; background: var(--bg-color); 
      color: var(--text-main); -webkit-font-smoothing: antialiased;
      user-select: none; -webkit-user-select: none;
    }
    #appContainer { display: block; }
    #illegalWarning { display: none; text-align: center; margin-top: 50px; padding: 20px; }
    .container { background: var(--card-bg); padding: 32px 24px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); text-align: center; }
    #mainHeading { display: block; margin: 0 auto 4px auto; font-size: 26px; word-break: break-all; font-weight: 700; }
    #subHeading { display: block; color: var(--text-secondary); font-size: 20px; margin: 0 auto 15px auto; min-height: 1.2em; word-break: break-all; font-weight: 600; }
    .input-wrapper { position: relative; width: 100%; margin: 20px 0; }
    input#secretInput {
      width: 100%; padding: 16px; border: 2px solid var(--primary-color); background: #ffffff;
      border-radius: 14px; box-sizing: border-box; font-size: 15px; outline: none;
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.1); user-select: text; -webkit-user-select: text;
    }
    .active-secret-bar { display: none; background-color: #f0f7ff; color: #1c1c1e; padding: 12px 16px; border-radius: 14px; font-size: 14px; font-weight: 700; margin: -10px 0 20px 0; border: 1px solid rgba(0, 122, 255, 0.1); justify-content: center; }
    .totp-display { font-size: 64px; color: var(--success-color); font-weight: 700; margin: 10px 0; font-variant-numeric: tabular-nums; letter-spacing: 0.15em; }
    .waiting { color: #d1d1d6; font-size: 32px; letter-spacing: 0; }
    .copy-btn { width: 100%; padding: 15px; border: none; border-radius: 14px; font-weight: 600; cursor: pointer; font-size: 16px; margin-top: 10px; background-color: var(--primary-color); color: white; }
    .copy-btn:disabled { background-color: #e5e5ea; cursor: not-allowed; }
    .red-notice { display: none; min-height: 40px; font-size: 14px; margin-bottom: 10px; align-items: center; justify-content: center; }
    .security-notice { margin-top: 25px; font-size: 13px; color: var(--text-secondary); line-height: 1.6; padding: 15px; border-radius: 16px; background: rgba(255, 59, 48, 0.03); border: 1px dashed var(--error-color); }
    .download-link { display: inline-flex; align-items: center; justify-content: center; margin-top: 8px; color: var(--primary-color); font-weight: 700; text-decoration: none; cursor: pointer; }
    #imageOverlay { display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: white; border: 2px solid var(--primary-color); border-radius: 12px; align-items: center; padding: 0 12px; z-index: 100; }
    #imgThumbnail { height: 70%; border-radius: 4px; }
  </style>
</head>
<body>

  <div id="illegalWarning">
    <h3>âš ï¸ è¿è¡Œç¯å¢ƒå¼‚å¸¸</h3>
    <p>æœ¬é¡µé¢ä¸æ”¯æŒç›´æ¥é€šè¿‡æµè§ˆå™¨å¦å­˜ä¸ºã€‚è¯·è¿”å›åŸç½‘é¡µé€šè¿‡æŒ‡å®šé“¾æ¥ä¸‹è½½ã€‚</p>
  </div>

  <div id="appContainer">
    <div class="container">
      <h2 id="mainHeading">OTP èº«ä»½éªŒè¯å™¨</h2>
      <h2 id="subHeading"></h2>
      
      <div class="input-wrapper">
        <input type="text" id="secretInput" placeholder="ç²˜è´´äºŒç»´ç æˆªå›¾ æˆ– è¾“å…¥å¯†é’¥" spellcheck="false" />
        <div id="imageOverlay"><img id="imgThumbnail" alt="ç¼©ç•¥å›¾"><span style="margin-left:10px; font-size:12px; color:var(--primary-color); font-weight:600;">è¯†åˆ«ä¸­...</span></div>
      </div>

      <div id="activeSecretBar" class="active-secret-bar">ğŸ”‘ å¯†é’¥: <span id="displaySecretValue" style="margin-left:5px;"></span></div>
      <div id="detectionMsg" class="red-notice"></div>
      <div class="totp-display waiting" id="totp">ç­‰å¾…è¾“å…¥</div>
      
      <div id="countdown-area" style="display: none; margin-bottom: 15px;">
          <span style="color:var(--text-secondary); font-size:15px; font-weight: 600;">æ›´æ–°å‰©ä½™:</span>
          <span id="countdown-num" style="color:var(--primary-color); font-weight:bold; font-size:20px; margin-left:8px;">--s</span>
      </div>
      
      <button class="copy-btn" id="copyBtn" onclick="copyTOTP()" disabled>å¤åˆ¶éªŒè¯ç </button>

      <div id="downloadZone" class="security-notice">
        æç¤ºï¼šæ•°æ®ä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ã€‚<br>
        <a class="download-link" onclick="downloadPage()">
          <span>[ ä¿å­˜å½“å‰ä¿¡æ¯ä¸ºæœ¬åœ°ç‹¬ç«‹ HTML ]</span>
        </a>
      </div>
    </div>
  </div>

  <script id="mainScript">
    // --- æ ¸å¿ƒé˜²ç›—é€»è¾‘ ---
    var isAuthorizedExport = false; 
    var injectedParams = null;

    function checkEnvironment() {
      const isLocal = window.location.protocol === 'file:';
      // å¦‚æœæ˜¯æœ¬åœ°æ‰“å¼€ä¸”æœªæˆæƒï¼ˆä¸æ˜¯ç‚¹æŒ‰é’®ä¸‹è½½çš„ï¼‰
      if (isLocal && !isAuthorizedExport) {
        document.getElementById('appContainer').style.display = 'none';
        document.getElementById('illegalWarning').style.display = 'block';
        return false;
      }
      return true;
    }

    window.addEventListener('contextmenu', e => e.preventDefault());
    window.addEventListener('keydown', e => {
      if ((e.ctrlKey || e.metaKey) && (e.key === 's' || e.key === 'S')) {
        e.preventDefault();
        alert("è¯·ç‚¹å‡»é¡µé¢å†…çš„ [ä¿å­˜] æŒ‰é’®è¿›è¡Œä¸‹è½½ã€‚");
      }
    });

    const secretInput = document.getElementById('secretInput');
    const totpDisplay = document.getElementById('totp');
    const copyBtn = document.getElementById('copyBtn');
    const mainHeading = document.getElementById('mainHeading');
    const subHeading = document.getElementById('subHeading');
    const activeSecretBar = document.getElementById('activeSecretBar');
    const displaySecretValue = document.getElementById('displaySecretValue');
    const countdownArea = document.getElementById('countdown-area');
    const countdownNum = document.getElementById('countdown-num');

    let isJumping = false;

    function getParams() {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('secret')) return Object.fromEntries(urlParams);
      return injectedParams;
    }

    async function updateUI() {
      if (!checkEnvironment() || isJumping) return;

      const params = getParams();
      const inputVal = secretInput.value.trim().replace(/\s/g, '').toUpperCase();
      
      let secret = inputVal || (params ? params.secret : "");
      
      if (!secret) {
        mainHeading.textContent = "OTP èº«ä»½éªŒè¯å™¨";
        subHeading.textContent = "";
        totpDisplay.textContent = "ç­‰å¾…è¾“å…¥";
        totpDisplay.classList.add('waiting');
        copyBtn.disabled = true;
        activeSecretBar.style.display = 'none';
        countdownArea.style.display = 'none';
        return;
      }

      // æ›´æ–°æ ‡é¢˜é€»è¾‘
      if (inputVal) {
        mainHeading.textContent = "æ‰‹åŠ¨è¾“å…¥è¯†åˆ«";
        subHeading.textContent = "";
      } else if (params) {
        mainHeading.textContent = params.issuer || "å·²ä¿å­˜å¯†é’¥";
        subHeading.textContent = params.label || "";
      }

      activeSecretBar.style.display = 'flex';
      displaySecretValue.textContent = secret;

      try {
        const epoch = Math.floor(Date.now() / 1000);
        const remain = 30 - (epoch % 30);
        countdownArea.style.display = 'block';
        countdownNum.textContent = remain + "s";

        const key = base32ToBytes(secret);
        const counter = Math.floor(epoch / 30);
        const code = await generateTOTP(key, counter);
        
        totpDisplay.textContent = code;
        totpDisplay.classList.remove('waiting');
        copyBtn.disabled = false;
        document.title = (params?.issuer || "OTP") + " - " + code;
      } catch (e) {
        totpDisplay.textContent = "æ ¼å¼æ— æ•ˆ";
        copyBtn.disabled = true;
      }
    }

    async function generateTOTP(key, counter) {
      const cryptoKey = await crypto.subtle.importKey('raw', key, { name: 'HMAC', hash: 'SHA-1' }, false, ['sign']);
      const data = new Uint8Array(8);
      const v = BigInt(counter);
      for (let i = 0; i < 8; i++) data[7 - i] = Number((v >> BigInt(i * 8)) & 0xffn);
      const hmac = new Uint8Array(await crypto.subtle.sign('HMAC', cryptoKey, data));
      const offset = hmac[19] & 0xf;
      const result = ((hmac[offset] & 0x7f) << 24 | (hmac[offset+1] & 0xff) << 16 | (hmac[offset+2] & 0xff) << 8 | (hmac[offset+3] & 0xff)) % 1000000;
      return result.toString().padStart(6, '0');
    }

    function base32ToBytes(s) {
      const alpha = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
      let bits = "";
      for (let i = 0; i < s.length; i++) {
        const val = alpha.indexOf(s[i].toUpperCase());
        if (val >= 0) bits += val.toString(2).padStart(5, '0');
      }
      const bytes = [];
      for (let i = 0; i + 8 <= bits.length; i += 8) bytes.push(parseInt(bits.substr(i, 8), 2));
      return new Uint8Array(bytes);
    }

    function downloadPage() {
      const params = getParams() || { secret: secretInput.value.trim(), issuer: "æ‰‹åŠ¨è¾“å…¥", label: "" };
      let docClone = document.documentElement.cloneNode(true);
      let script = docClone.querySelector('#mainScript');
      
      let newContent = script.innerHTML
        .replace(/var isAuthorizedExport = false;/, 'var isAuthorizedExport = true;')
        .replace(/var injectedParams = null;/, `var injectedParams = ${JSON.stringify(params)};`);
      
      script.innerHTML = newContent;
      const blob = new Blob(["<!DOCTYPE html>\n" + docClone.outerHTML], { type: 'text/html' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = (params.issuer || 'OTP') + '.html';
      a.click();
    }

    document.addEventListener('paste', e => {
      const item = [...(e.clipboardData || e.originalEvent.clipboardData).items].find(i => i.type.indexOf('image') !== -1);
      if (item) {
        const reader = new FileReader();
        reader.onload = event => {
          document.getElementById('imageOverlay').style.display = 'flex';
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = img.width; canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            const code = jsQR(ctx.getImageData(0,0,canvas.width,canvas.height).data, canvas.width, canvas.height);
            if (code) {
              const url = new URL(code.data.replace('otpauth://totp/', 'http://x/'));
              const secret = url.searchParams.get('secret');
              const issuer = url.searchParams.get('issuer') || url.pathname.split(':')[0].replace('/','');
              const label = url.pathname.split(':').pop();
              const next = new URL(window.location.href);
              next.searchParams.set('secret', secret);
              next.searchParams.set('issuer', issuer);
              next.searchParams.set('label', label);
              isJumping = true;
              window.location.href = next.href;
            } else {
              alert("æœªè¯†åˆ«åˆ°äºŒç»´ç ");
              document.getElementById('imageOverlay').style.display = 'none';
            }
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(item.getAsFile());
      }
    });

    async function copyTOTP() {
      await navigator.clipboard.writeText(totpDisplay.textContent);
      copyBtn.textContent = 'âœ… å·²å¤åˆ¶';
      setTimeout(() => copyBtn.textContent = 'å¤åˆ¶éªŒè¯ç ', 2000);
    }

    setInterval(updateUI, 1000);
    updateUI();
  </script>
</body>
</html>
