<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OTP èº«ä»½éªŒè¯å™¨</title>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    :root {
      --primary-color: #007aff; --success-color: #34c759; --error-color: #ff3b30;
      --bg-color: #f2f2f7; --card-bg: #ffffff; --text-main: #1c1c1e; --text-secondary: #3a3a3c;
    }
    body { 
      font-family: "Lantinghei SC", "Microsoft YaHei", -apple-system, sans-serif; 
      max-width: 480px; margin: 0 auto; padding: 40px 20px; background: var(--bg-color); 
      color: var(--text-main); -webkit-font-smoothing: antialiased;
      user-select: none; -webkit-user-select: none;
    }
    /* é»˜è®¤éšè—ä¸»å®¹å™¨ï¼Œæ ¡éªŒé€šè¿‡å†æ˜¾ç¤º */
    #appContainer { display: none; }
    .container { background: var(--card-bg); padding: 32px 24px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); text-align: center; }
    #mainHeading { display: block; margin: 0 auto 4px auto; font-size: 26px; word-break: break-all; font-weight: 700; }
    #subHeading { display: block; color: var(--text-secondary); font-size: 22px; margin: 0 auto 15px auto; min-height: 1.2em; word-break: break-all; font-weight: 600; }
    .input-wrapper { position: relative; width: 100%; margin: 20px 0; }
    input#secretInput {
      width: 100%; padding: 16px; border: 2px solid var(--primary-color); background: #ffffff;
      border-radius: 14px; box-sizing: border-box; font-size: 15px; outline: none;
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.1); user-select: text; -webkit-user-select: text;
    }
    .active-secret-bar { display: none; background-color: #f0f7ff; color: #1c1c1e; padding: 12px 16px; border-radius: 14px; font-size: 14px; font-weight: 700; margin: -10px 0 20px 0; border: 1px solid rgba(0, 122, 255, 0.1); justify-content: center; }
    .totp-display { font-size: 64px; color: var(--success-color); font-weight: 700; margin: 10px 0; font-variant-numeric: tabular-nums; letter-spacing: 0.15em; }
    .waiting { color: #d1d1d6; font-size: 32px; }
    .copy-btn, .next-btn { width: 100%; padding: 15px; border: none; border-radius: 14px; font-weight: 600; cursor: pointer; font-size: 16px; margin-top: 10px; }
    .copy-btn { background-color: var(--primary-color); color: white; }
    .next-btn { background-color: #e5e5ea; color: var(--text-main); display: none; }
    .copy-btn:disabled { background-color: #e5e5ea; }
    .red-notice { display: none; min-height: 55px; font-size: 14px; margin-bottom: 10px; align-items: center; justify-content: center; }
    .security-notice { margin-top: 25px; font-size: 13px; color: var(--text-secondary); line-height: 1.6; padding: 15px; border-radius: 16px; background: rgba(255, 59, 48, 0.03); border: 1px dashed var(--error-color); }
    .download-link { display: inline-flex; align-items: center; justify-content: center; margin-top: 8px; color: var(--primary-color); font-weight: 700; text-decoration: none; cursor: pointer; }
    #bookmarkHint { display: none; margin-top: 12px; font-size: 12px; color: var(--text-secondary); }
    .kbd-key { display: inline-block; padding: 1px 5px; margin: 0 2px; font-size: 10px; font-weight: 800; background: #fafafa; border: 1px solid #d1d1d6; border-radius: 4px; box-shadow: 0 1px 0 #c1c1c6; }
    #imageOverlay { display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: white; border: 2px solid var(--primary-color); border-radius: 12px; align-items: center; padding: 0 12px; z-index: 100; }
    #imgThumbnail { height: 70%; border-radius: 4px; }
  </style>
</head>
<body>

  <div id="illegalWarning" style="display:block; text-align:center; margin-top:50px;">
    <h3>âš ï¸Error</h3>
    <p>The save page is not not-allowed running in local env.</p>
    <p>Please use from the originalâ€Œ website.</p>
    <p>download is allowed only at the tips link.</p>
  </div>

  <div id="appContainer">
    <div class="container">
      <h2 id="mainHeading">OTP èº«ä»½éªŒè¯å™¨</h2>
      <h2 id="subHeading"></h2>
      
      <div class="input-wrapper">
        <input type="text" id="secretInput" placeholder="åœ¨è¿™é‡Œç²˜è´´äºŒç»´ç æˆªå›¾ æˆ– è¾“å…¥å¯†é’¥" spellcheck="false" />
        <div id="imageOverlay"><img id="imgThumbnail" alt="ç¼©ç•¥å›¾"><span style="margin-left:10px; font-size:12px; color:var(--primary-color); font-weight:600;">è¯†åˆ«ä¸­...</span></div>
      </div>

      <div id="activeSecretBar" class="active-secret-bar">ğŸ”‘ å½“å‰æœ‰æ•ˆå¯†é’¥: <span id="displaySecretValue" style="margin-left:5px;"></span></div>
      <div id="detectionMsg" class="red-notice"></div>
      <div class="totp-display waiting" id="totp">ç­‰å¾…è¾“å…¥</div>
      
      <div id="countdown-area" style="display: none; margin-bottom: 15px;">
          <span style="color:var(--text-secondary); font-size:15px; font-weight: 600;">æ›´æ–°å‰©ä½™:</span>
          <span id="countdown-num" style="color:var(--primary-color); font-weight:bold; font-size:20px; margin-left:8px;">--s</span>
      </div>
      
      <button class="copy-btn" id="copyBtn" onclick="copyTOTP()" disabled>å¤åˆ¶éªŒè¯ç </button>
      <button class="next-btn" id="nextBtn" onclick="incrementHOTP()">ä¸‹ä¸€æ­¥è®¡æ•° (HOTP)</button>

      <div id="downloadZone" class="security-notice">
        æç¤ºï¼šæœ¬é¡µé¢ä»£ç åœ¨æœ¬åœ°æµè§ˆå™¨è¿è¡Œï¼ŒæœåŠ¡å™¨ä¸ä¿å­˜ä»»ä½•ä¿¡æ¯ã€‚<br>
        <a class="download-link" onclick="downloadPage()">
          <span id="downloadBtnText">[ ä¿å­˜å½“å‰ä¿¡æ¯ä¸ºæœ¬åœ°ç‹¬ç«‹ HTML ]</span>
        </a>
      </div>
      <div id="bookmarkHint">ä½¿ç”¨å¿«æ·é”® <span class="kbd-key">Ctrl</span> + <span class="kbd-key">D</span> æ·»åŠ åˆ°æ”¶è—å¤¹</div>
    </div>
  </div>

  <script id="mainScript">
    // --- æ ¸å¿ƒé˜²ç›—é€»è¾‘ ---
    // æ ‡è®°ä½ï¼šåªæœ‰é€šè¿‡ downloadPage å‡½æ•°ç”Ÿæˆçš„ HTML æ‰ä¼šå°†æ­¤å€¼æ”¹ä¸º true
    var isAuthorizedExport = false; 

    function checkEnvironment() {
      const isLocalFile = window.location.protocol === 'file:';
      // å¦‚æœæ˜¯æœ¬åœ°æ‰“å¼€ï¼Œä¸”ä¸æ˜¯é€šè¿‡æˆ‘ä»¬æŒ‰é’®å¯¼å‡ºçš„ï¼ˆæˆæƒæ ‡è®°ä¸ºfalseï¼‰ï¼Œåˆ™é”å®šé¡µé¢
      if (isLocalFile && !isAuthorizedExport) {
        document.getElementById('appContainer').style.display = 'none';
        document.getElementById('illegalWarning').style.display = 'block';
        return false;
      }
      document.getElementById('appContainer').style.display = 'block';
      document.getElementById('illegalWarning').style.display = 'none';
      return true;
    }

    // ç¦ç”¨å³é”®å’Œä¿å­˜å¿«æ·é”®
    window.addEventListener('contextmenu', e => e.preventDefault());
    window.addEventListener('keydown', e => {
      if ((e.ctrlKey || e.metaKey) && (e.key === 's' || e.key === 'S')) {
        e.preventDefault();
        alert("è¯·ä½¿ç”¨é¡µé¢å†…çš„ä¿å­˜æŒ‰é’®ã€‚");
      }
    });

    var injectedParams = null;
    const secretInput = document.getElementById('secretInput');
    const totpDisplay = document.getElementById('totp');
    const copyBtn = document.getElementById('copyBtn');
    const nextBtn = document.getElementById('nextBtn');
    const mainHeading = document.getElementById('mainHeading');
    const subHeading = document.getElementById('subHeading');
    const activeSecretBar = document.getElementById('activeSecretBar');
    const displaySecretValue = document.getElementById('displaySecretValue');
    const detectionMsg = document.getElementById('detectionMsg');
    const bookmarkHint = document.getElementById('bookmarkHint');

    let currentConfig = { type: 'totp', secret: '', counter: 0 };
    let isJumping = false;

    function getCurrentParams() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('secret') ? Object.fromEntries(urlParams) : injectedParams;
    }

    function downloadPage() {
      let latestParams = getCurrentParams() || { type: "totp", secret: "ABCDEFGHIJKLMNOP", issuer: "å‘è¡Œå•†", label: "æµ‹è¯•è´¦å·" };
      let docClone = document.documentElement.cloneNode(true);
      let scriptElement = docClone.querySelector('#mainScript');
      
      // å¯¼å‡ºæ—¶ï¼Œå°†æ ‡è®°ä½è®¾ä¸º true
      let scriptContent = scriptElement.innerHTML
        .replace(/var injectedParams = (null|{.*?});/, `var injectedParams = ${JSON.stringify(latestParams)};`)
        .replace(/var isAuthorizedExport = false;/, `var isAuthorizedExport = true;`);

      scriptElement.innerHTML = scriptContent;
      const blob = new Blob(["<!DOCTYPE html>\n" + docClone.outerHTML], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = latestParams.issuer ? `OTP_${latestParams.issuer}.html` : 'OTP_Authenticator.html';
      a.click();
    }

    // ç»´æŒåŸæœ‰é€»è¾‘...
    document.addEventListener('paste', (e) => {
      const items = (e.clipboardData || e.originalEvent.clipboardData).items;
      for (const item of items) {
        if (item.type.indexOf('image') !== -1) {
          const file = item.getAsFile();
          const reader = new FileReader();
          reader.onload = (event) => {
            document.getElementById('imageOverlay').style.display = 'flex';
            document.getElementById('imgThumbnail').src = event.target.result;
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              canvas.width = img.width; canvas.height = img.height;
              ctx.drawImage(img, 0, 0);
              const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
              if (typeof jsQR !== 'undefined') {
                const code = jsQR(imageData.data, canvas.width, canvas.height);
                if (code) handleResult(code.data);
                else { showError("å›¾ç‰‡ä¸­æœªå‘ç°äºŒç»´ç "); document.getElementById('imageOverlay').style.display = 'none'; }
              }
            };
            img.src = event.target.result;
          };
          reader.readAsDataURL(file);
        }
      }
    });

    function handleResult(content) {
      const sMatch = content.match(/secret=([A-Z2-7=]+)/i);
      const secret = sMatch ? sMatch[1].toUpperCase() : (content.match(/[A-Z2-7=]{16,}/i)?.[0].toUpperCase());
      if (secret) {
        isJumping = true;
        const url = new URL(window.location.href);
        url.searchParams.set('secret', secret);
        url.searchParams.set('type', content.includes('hotp') ? 'hotp' : 'totp');
        detectionMsg.style.display = 'flex';
        detectionMsg.innerHTML = `<b style="color:var(--primary-color)">æ­£åœ¨é‡è½½...</b>`;
        setTimeout(() => window.location.href = url.href, 500);
      }
    }

    async function updateUI() {
      if (isJumping || !checkEnvironment()) return;
      const urlParams = new URLSearchParams(window.location.search);
      const urlSecret = urlParams.get('secret') || (injectedParams ? injectedParams.secret : null);
      const inputSecret = secretInput.value.trim();
      let activeSecret = ""; let activeType = "totp";

      if (inputSecret) {
        activeSecret = inputSecret.replace(/\s/g, '').toUpperCase();
        mainHeading.textContent = "æ‰‹åŠ¨è¾“å…¥è¯†åˆ«"; document.title = "è¯†åˆ«ä¸­...";
        bookmarkHint.style.display = 'none';
      } else if (urlSecret) {
        activeSecret = urlSecret;
        const params = urlParams.get('secret') ? urlParams : new URLSearchParams(injectedParams);
        activeType = params.get('type') || 'totp';
        const issuer = params.get('issuer'), label = params.get('label');
        mainHeading.textContent = issuer || "å·²è¯†åˆ«å¯†é’¥";
        subHeading.textContent = label || "";
        document.title = issuer ? `${issuer} - éªŒè¯ç ` : "éªŒè¯ç ";
        bookmarkHint.style.display = 'block';
      } else {
        mainHeading.textContent = "OTP èº«ä»½éªŒè¯å™¨"; document.title = "OTP èº«ä»½éªŒè¯å™¨";
        totpDisplay.textContent = "ç­‰å¾…è¾“å…¥"; totpDisplay.classList.add('waiting');
        copyBtn.disabled = true; activeSecretBar.style.display = 'none'; return;
      }

      activeSecretBar.style.display = 'flex';
      displaySecretValue.textContent = activeSecret;
      try {
        const key = base32ToBytes(activeSecret);
        let cv = (activeType === 'hotp') ? currentConfig.counter : Math.floor(Date.now() / 1000 / 30);
        document.getElementById('countdown-area').style.display = 'block';
        if (activeType === 'totp') document.getElementById('countdown-num').textContent = (30 - (Math.floor(Date.now() / 1000) % 30)) + "s";
        const cryptoKey = await crypto.subtle.importKey('raw', key, { name: 'HMAC', hash: 'SHA-1' }, false, ['sign']);
        const hmac = new Uint8Array(await crypto.subtle.sign('HMAC', cryptoKey, new Uint8Array(8).map((_,i) => (cv >> (56-i*8)) & 0xff)));
        const offset = hmac[19] & 0xf;
        const code = ((hmac[offset] & 0x7f) << 24 | (hmac[offset+1] & 0xff) << 16 | (hmac[offset+2] & 0xff) << 8 | (hmac[offset+3] & 0xff)) % 1000000;
        totpDisplay.textContent = code.toString().padStart(6, '0');
        totpDisplay.classList.remove('waiting'); copyBtn.disabled = false;
      } catch (e) { totpDisplay.textContent = "æ ¼å¼æ— æ•ˆ"; }
    }

    function base32ToBytes(s) {
      const alpha = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
      let bits = [...s].map(c => alpha.indexOf(c).toString(2).padStart(5, '0')).join('');
      return new Uint8Array(bits.match(/.{8}/g).map(b => parseInt(b, 2)));
    }

    async function copyTOTP() {
      await navigator.clipboard.writeText(totpDisplay.textContent);
      const old = copyBtn.textContent; copyBtn.textContent = 'âœ… å·²å¤åˆ¶';
      setTimeout(() => copyBtn.textContent = old, 2000);
    }

    function showError(msg) {
      detectionMsg.style.display = 'flex';
      detectionMsg.innerHTML = `<div style="color:red">âŒ ${msg}</div>`;
      setTimeout(() => { detectionMsg.style.display = 'none'; }, 3000);
    }

    secretInput.addEventListener('input', updateUI);
    setInterval(updateUI, 1000);
    updateUI();
  </script>
</body>
</html>
